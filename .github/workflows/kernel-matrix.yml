name: txgbe build matrix

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    # NOTE:
    # - For real use, prefer a self-hosted runner where you can pre-install and cache
    #   multiple prepared kernel trees/headers.
    # - Replace 'ubuntu-latest' with 'self-hosted' (or your labels) if desired.
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          # TODO: Replace kdir paths with actual kernel build trees or prepared headers on your runner.
          # KERNELDIR should point to a directory that contains:
          #   - include/generated/autoconf.h  (or include/linux/autoconf.h on very old trees)
          # and is suitable for: make -C "$KERNELDIR" M="$PWD/src" modules
          - kernel: "4.19"
            kdir: "/opt/kernels/linux-4.19"
          - kernel: "5.4"
            kdir: "/opt/kernels/linux-5.4"
          - kernel: "5.10"
            kdir: "/opt/kernels/linux-5.10"
          - kernel: "5.15"
            kdir: "/opt/kernels/linux-5.15"
          - kernel: "6.1"
            kdir: "/opt/kernels/linux-6.1"
          - kernel: "6.6"
            kdir: "/opt/kernels/linux-6.6"
          - kernel: "6.12"
            kdir: "/opt/kernels/linux-6.12"
          - kernel: "6.18"
            kdir: "/opt/kernels/linux-6.18"

    steps:
      - name: Checkout
        uses: actions/checkout @v4

      - name: Toolchain info
        run: |
          set -eux
          uname -a
          gcc --version
          make --version

      - name: Build module (or skip if KERNELDIR missing)
        env:
          KERNELDIR: ${{ matrix.kdir }}
        run: |
          set -euo pipefail
          LOG="build-${{ matrix.kernel }}.log"
          {
            echo "Kernel: ${{ matrix.kernel }}"
            echo "KERNELDIR=$KERNELDIR"
            echo
          } > "$LOG"

          if [ ! -d "$KERNELDIR" ]; then
            echo "::warning::KERNELDIR does not exist: $KERNELDIR"
            {
              echo "SKIPPED: KERNELDIR does not exist on this runner."
              echo
              echo "This workflow is intended for a self-hosted runner with multiple kernel trees/headers."
              echo "Either:"
              echo "  - switch runs-on to self-hosted and preinstall kernel trees/headers under the paths in matrix, or"
              echo "  - edit matrix.kdir to match your environment."
            } >> "$LOG"
            exit 0
          fi

          # Prepare headers if needed (best-effort; requires a configured kernel tree).
          if [ -f "$KERNELDIR/include/generated/autoconf.h" ] || [ -f "$KERNELDIR/include/linux/autoconf.h" ]; then
            echo "Kernel config header found, skipping modules_prepare." | tee -a "$LOG"
          else
            echo "Kernel tree not prepared (autoconf.h not found)." | tee -a "$LOG"
            echo "Running: make -C "$KERNELDIR" olddefconfig prepare modules_prepare" | tee -a "$LOG"
            make -C "$KERNELDIR" olddefconfig 2>&1 | tee -a "$LOG"
            make -C "$KERNELDIR" prepare modules_prepare 2>&1 | tee -a "$LOG"
          fi

          make -C "$KERNELDIR" M="${GITHUB_WORKSPACE}/src" clean
          make -C "$KERNELDIR" M="${GITHUB_WORKSPACE}/src" modules V=1 2>&1 | tee -a "$LOG"

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact @v4
        with:
          name: build-log-${{ matrix.kernel }}
          path: build-${{ matrix.kernel }}.log