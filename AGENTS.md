# AGENTS.md (repository root)

This repository contains an out-of-tree Linux kernel module (txgbe driver).
When working on this codebase, prioritize **kernel compatibility and regressions prevention**
over refactoring or stylistic changes.

## Golden rules (must follow)
1. **No refactors by default.** Do not rename, reorder, reformat, or “clean up” code unless it is
   strictly required to fix a build break and the change set stays minimal.
2. **Do not guess kernel APIs by version.** Prefer the existing kcompat feature-detection system:
   `src/generated.sh` -> `src/kcompat-generator.sh` -> `src/kcompat_generated_defs.h`.
   Add/adjust **feature checks** (HAVE_/NEED_) instead of `#if LINUX_VERSION_CODE ...` logic.
3. **Do not change functional behavior** when adding compatibility. The target is: “builds and runs
   the same” across supported kernels.
4. **Generated files must not be committed.** `src/kcompat_generated_defs.h` is autogenerated.
   Ensure it is produced during build and removed by clean. Add it to `.gitignore`.
5. **One kernel at a time.** Any compatibility work must be validated by building against each
   supported kernel tree/headers, not just “latest”.

## Supported kernel range (project policy)
Target kernels (must not regress):
- 4.19, 5.4, 5.10, 5.15, 6.1, 6.6, 6.12, 6.18

If a patch fixes one kernel but breaks another, the patch is not acceptable.

## Required workflow for compatibility patches
1. Pick one kernel version (one KERNELDIR) and reproduce the build error.
2. Regenerate kcompat defines for that kernel:
   - `make -C "$KERNELDIR" M="$PWD/src" clean`
   - `make -C "$KERNELDIR" M="$PWD/src" modules`
3. Fix build errors with the smallest possible change set:
   - Prefer changes in `src/kcompat*.h`, `src/kcompat*.c`, generator scripts, and build glue.
   - Avoid touching “main driver” files unless unavoidable.
4. Rebuild the same kernel until clean.
5. Rebuild **all** supported kernels (matrix build) before considering the change complete.

## Build commands (typical)
Out-of-tree build:
- `export ARCH=arm64`
- `export CROSS_COMPILE=aarch64-linux-gnu-`
- `export KERNELDIR=/path/to/kernel/tree-or-headers`
- `make -C "$KERNELDIR" M="$PWD/src" modules -j"$(nproc)"`

Clean:
- `make -C "$KERNELDIR" M="$PWD/src" clean`

## What to avoid
- Introducing new netdev ops / ethtool ops “because newer kernels have them”.
- Large sweeping changes across many files.
- Manual edits to `kcompat_generated_defs.h` (always regenerate instead).

## Commit / PR expectations
- Keep patches small and kernel-specific.
- Mention which kernels were built (list exact versions) and attach build logs if available.

