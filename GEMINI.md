# Project Overview

This repository contains an out-of-tree Linux kernel module, `txgbe`, designed for LR-LINK LRES1002PF-2SFP+ (dual SFP+, 10GbE) NICs. The primary goal is to provide stable compatibility across multiple Long Term Support (LTS) Linux kernel versions (4.19, 5.4, 5.10, 5.15, 6.1, 6.6, 6.12, 6.18) without introducing regressions.

The project is implemented in C and uses the standard Linux kernel build system (kbuild). A core component is the `kcompat` compatibility layer, which dynamically adapts the driver to varying kernel APIs.

## Building and Running

### Prerequisites

-   A kernel build tree or headers for the target kernel (`KERNELDIR`). Ensure the kernel tree is prepared (e.g., `make modules_prepare`).
-   `make`, a C compiler toolchain (native or cross-compiler if targeting a different architecture).

### Standard Build (against a single kernel)

To build the module against a specific kernel (e.g., the currently running kernel), navigate to the project root and use:

```bash
make -C /lib/modules/$(uname -r)/build M=$PWD/src modules -j"$(nproc)"
```

For a specific `KERNELDIR`:

```bash
export KERNELDIR=/path/to/kernel/tree-or-headers
make -C "$KERNELDIR" M="$PWD/src" modules -j"$(nproc)"
```

The output module will be `src/txgbe.ko`.

### Cross-Build (example for arm64)

```bash
export ARCH=arm64
export CROSS_COMPILE=aarch64-linux-gnu-
export KERNELDIR=/path/to/kernel/tree
make -C "$KERNELDIR" M="$PWD/src" modules -j"$(nproc)"
```

### Building against multiple kernels (Matrix Build)

The `tools/build_matrix.sh` script automates building the module against multiple specified kernel trees. This is the recommended way to validate compatibility across all supported kernels.

```bash
# Example: Build against kernel trees located at these paths
export KERNELDIRS="/path/to/kernel-4.19 /path/to/kernel-5.4 /path/to/kernel-5.10 /path/to/kernel-5.15 /path/to/kernel-6.1 /path/to/kernel-6.6 /path/to/kernel-6.12 /path/to/kernel-6.18"
./tools/build_matrix.sh
```

-   `KEEP_GOING=1` (default): Continue building even if one kernel fails.
-   `CLEAN_FIRST=1` (default): Perform a `make clean` before each build, ensuring `kcompat_generated_defs.h` is regenerated.
-   `LOGDIR=logs` (default): Store build logs in the `logs/` directory.

### Cleaning Build Artifacts

To clean generated files for a specific kernel:

```bash
export KERNELDIR=/path/to/kernel/tree
make -C "$KERNELDIR" M="$PWD/src" clean
```

Or for a standalone clean:

```bash
make clean # from the src/ directory or main Makefile
```

This removes `kcompat_generated_defs.h` and other build artifacts.

### Installing and Loading the Module

**Temporary Load (for testing):**

```bash
sudo insmod src/txgbe.ko
# Verify with: dmesg | tail -n 200, ip link, ethtool -i <iface>
```

**System-wide Installation:**

```bash
sudo make -C "$KERNELDIR" M="$PWD/src" modules_install
sudo depmod -a
```

## Development Conventions

### Kernel Compatibility (kcompat system)

The project relies heavily on a `kcompat` layer to manage differences in kernel APIs across versions.

-   **Feature Detection:** The `src/kcompat-generator.sh` script (invoked via `generated.sh` in the build process) scans target kernel headers to detect the presence or absence of specific features. It then generates `HAVE_` and `NEED_` preprocessor defines in `src/kcompat_generated_defs.h`.
-   **Wrapper and Backports:** `src/kcompat.h`, `src/kcompat_defs.h`, and `src/kcompat.c` (and potentially `kcompat_impl.h`) use these `HAVE_`/`NEED_` flags to provide wrappers or backported implementations for kernel functions, structs, or macros that have changed or are missing in certain kernel versions.
-   **Autogenerated File:** `src/kcompat_generated_defs.h` is *always* autogenerated during the build for the specific `KERNELDIR` being compiled against. It must *not* be committed to Git.

### Guidelines for Compatibility Patches

1.  **Prefer Feature Checks:** When addressing compatibility issues, prioritize adding or adjusting `HAVE_`/`NEED_` feature checks in `src/kcompat-generator.sh` and their corresponding wrappers/backports in `src/kcompat.c` or `src/kcompat.h`. Avoid direct `LINUX_VERSION_CODE` checks in core driver files unless absolutely unavoidable.
2.  **Minimal Changes:** Keep changes as minimal and localized as possible. Avoid large-scale refactoring or stylistic changes.
3.  **No Functional Change:** Compatibility fixes should aim to make the module build and run *identically* across supported kernels, without altering its functional behavior.
4.  **Test Thoroughly:** Always validate changes by rebuilding against the *entire matrix* of supported kernel versions (4.19, 5.4, 5.10, 5.15, 6.1, 6.6, 6.12, 6.18) using `tools/build_matrix.sh`. A fix for one kernel must not break another.

For a detailed workflow on making compatibility patches, refer to `AGENTS.md`.
