# AGENTS.md (src/)

This directory contains the txgbe kernel module sources and the kcompat layer.

## Code style
- Linux kernel style: tabs for indentation, kernel brace style.
- C comments must be in English.

## Compatibility architecture (do not bypass)
- `generated.sh` runs `kcompat-generator.sh` to detect features in the target kernel headers.
- Output: `kcompat_generated_defs.h` (autogenerated; must not be committed).
- `kcompat_defs.h` includes `kcompat_generated_defs.h` and project defaults.
- `kcompat_impl.h` contains backport implementations and wrappers.
- Driver sources include `kcompat.h` / `kcompat_defs.h` to adapt to kernels.

**Policy:** Prefer HAVE_/NEED_ feature flags over version checks.
If a distro backport forces a version check, isolate it in `kcompat_impl.h` with a clear comment.

## Where to implement fixes
Priority order:
1. Generator rules (`kcompat-generator.sh`, `kcompat-lib.sh`) when feature detection is missing.
2. Backport wrappers in `kcompat_impl.h` / `kcompat.c`.
3. Minimal glue changes (includes, prototypes) in driver files only when unavoidable.

## Build integration rules (kcompat_generated_defs.h)
- The generated header must be produced for the exact kernel used for compilation.
- If switching KERNELDIR, the generated header must be regenerated.
- Ensure `make clean` removes `kcompat_generated_defs.h`.

## Regression prevention checklist
Before finalizing a change:
- Verify the generated header corresponds to the kernel:
  - `grep -E "Autogenerated for KSRC=" kcompat_generated_defs.h`
- Build the module against all supported kernel trees/headers.
- Avoid touching unrelated warnings unless they are promoted to errors by the target kernel build.

## Common failure patterns
- Building against kernel A while `kcompat_generated_defs.h` was generated for kernel B.
- Adding version-based macros in `kcompat_std_defs.h` instead of generator feature flags.
- Fixing a warning by changing function signatures (breaks other kernels) instead of guarding with HAVE_/NEED_.

